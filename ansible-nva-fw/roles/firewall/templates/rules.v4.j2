# Generated by Ansible - NVA Firewall Rules
# Date: {{ ansible_date_time.iso8601 }}
# Host: {{ inventory_hostname }}
# Primary Interface: {{ primary_interface }}
# Internal Network: {{ main_internal_network_cidr }}

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# SNAT/MASQUERADE for internal networks going to internet
{% for network in allowed_networks %}
-A POSTROUTING -s {{ network }} -o {{ primary_interface }} -j MASQUERADE -m comment --comment "SNAT for {{ network }}"
{% endfor %}

COMMIT

*filter
:INPUT ACCEPT [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [0:0]

# Allow forwarding for established/related connections
-A FORWARD -m state --state RELATED,ESTABLISHED -j ACCEPT -m comment --comment "Allow established connections"

# Allow forwarding from internal networks
{% for network in allowed_networks %}
-A FORWARD -s {{ network }} -j ACCEPT -m comment --comment "Allow forwarding from {{ network }}"
{% endfor %}

{% if enable_drop_logging %}
# Log dropped packets for debugging
-A FORWARD -m limit --limit 5/min -j LOG --log-prefix "iptables-dropped: " --log-level 4
{% endif %}

COMMIT
