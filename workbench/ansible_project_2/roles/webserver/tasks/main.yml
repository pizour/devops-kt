---
# Webserver role - demonstrates package installation, service management, templates
# This role installs and configures nginx web server

- name: Install nginx
  ansible.builtin.package:
    name: nginx
    state: present
  tags:
    - webserver
    - packages

- name: Create web root directory
  ansible.builtin.file:
    path: /var/www/html
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'
  tags:
    - webserver

- name: Deploy nginx configuration
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
    validate: 'nginx -t -c %s'
  notify: restart nginx
  tags:
    - webserver
    - config

- name: Deploy site configuration
  ansible.builtin.template:
    src: site.conf.j2
    dest: /etc/nginx/sites-available/default
    owner: root
    group: root
    mode: '0644'
  notify: reload nginx
  tags:
    - webserver
    - config

- name: Deploy index page
  ansible.builtin.template:
    src: index.html.j2
    dest: /var/www/html/index.html
    owner: www-data
    group: www-data
    mode: '0644'
  tags:
    - webserver
    - content

- name: Ensure nginx is started and enabled
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: yes
  tags:
    - webserver
    - service

- name: Check if SSL is enabled
  ansible.builtin.debug:
    msg: "SSL is {{ 'enabled' if ssl_enabled else 'disabled' }} on {{ hostname }}"
  tags:
    - webserver
    - debug

- name: Configure SSL certificates (if enabled)
  block:
    - name: Create SSL directory
      ansible.builtin.file:
        path: /etc/nginx/ssl
        state: directory
        mode: '0750'

    - name: Generate self-signed certificate (demo only)
      ansible.builtin.command:
        cmd: >
          openssl req -x509 -nodes -days 365 -newkey rsa:2048
          -keyout /etc/nginx/ssl/server.key
          -out /etc/nginx/ssl/server.crt
          -subj "/C=DE/ST=State/L=City/O=Company/CN={{ hostname }}"
        creates: /etc/nginx/ssl/server.crt
      notify: restart nginx
  when: ssl_enabled | default(false)
  tags:
    - webserver
    - ssl
