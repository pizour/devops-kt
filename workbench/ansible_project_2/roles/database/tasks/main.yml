---
# Database role - demonstrates conditionals, variables, and file management
# This role installs and configures PostgreSQL

- name: Install PostgreSQL
  ansible.builtin.package:
    name:
      - postgresql
      - postgresql-contrib
      - python3-psycopg2
    state: present
  tags:
    - database
    - packages

- name: Ensure PostgreSQL is started and enabled
  ansible.builtin.service:
    name: postgresql
    state: started
    enabled: yes
  tags:
    - database
    - service

- name: Configure PostgreSQL
  ansible.builtin.template:
    src: postgresql.conf.j2
    dest: /etc/postgresql/{{ postgresql_version | default('14') }}/main/postgresql.conf
    owner: postgres
    group: postgres
    mode: '0644'
  notify: restart postgresql
  tags:
    - database
    - config

- name: Configure PostgreSQL authentication
  ansible.builtin.template:
    src: pg_hba.conf.j2
    dest: /etc/postgresql/{{ postgresql_version | default('14') }}/main/pg_hba.conf
    owner: postgres
    group: postgres
    mode: '0640'
  notify: restart postgresql
  tags:
    - database
    - config

- name: Create database directory for backups
  ansible.builtin.file:
    path: "{{ backup_destination | default('/var/backups/postgresql') }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0750'
  when: backup_enabled | default(true)
  tags:
    - database
    - backup

- name: Deploy backup script
  ansible.builtin.template:
    src: backup.sh.j2
    dest: /usr/local/bin/postgres-backup.sh
    owner: postgres
    group: postgres
    mode: '0750'
  when: backup_enabled | default(true)
  tags:
    - database
    - backup

- name: Configure backup cron job
  ansible.builtin.cron:
    name: "PostgreSQL backup"
    minute: "{{ backup_schedule.split()[0] }}"
    hour: "{{ backup_schedule.split()[1] }}"
    job: "/usr/local/bin/postgres-backup.sh"
    user: postgres
    state: present
  when:
    - backup_enabled | default(true)
    - backup_schedule is defined
  tags:
    - database
    - backup

# Conditional tasks based on database role
- name: Configure as primary database
  block:
    - name: Create application database
      community.postgresql.postgresql_db:
        name: "{{ db_name | default('appdb') }}"
        state: present
      become_user: postgres

    - name: Create database user
      community.postgresql.postgresql_user:
        name: "{{ db_user | default('appuser') }}"
        password: "{{ db_password | default('changeme') }}"
        state: present
      become_user: postgres

    - name: Grant privileges to user
      community.postgresql.postgresql_privs:
        database: "{{ db_name | default('appdb') }}"
        roles: "{{ db_user | default('appuser') }}"
        privs: ALL
        type: database
      become_user: postgres

    - name: Display primary database info
      ansible.builtin.debug:
        msg: "This server is configured as PRIMARY database server"
  when: database_role | default('primary') == 'primary'
  tags:
    - database
    - primary

- name: Configure as replica database
  block:
    - name: Display replica info
      ansible.builtin.debug:
        msg: "This server is configured as REPLICA, replicating from {{ replication_source }}"

    - name: Create replication configuration
      ansible.builtin.template:
        src: recovery.conf.j2
        dest: /var/lib/postgresql/{{ postgresql_version | default('14') }}/main/recovery.conf
        owner: postgres
        group: postgres
        mode: '0600'
      notify: restart postgresql
  when: database_role | default('primary') == 'replica'
  tags:
    - database
    - replica
