#!/bin/bash
# Fossology Backup Script
# Generated by Ansible for {{ hostname }}

BACKUP_DIR="{{ backup_destination }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS={{ backup_retention | default(7) }}

# Create backup directory
mkdir -p "$BACKUP_DIR"

echo "Starting Fossology backup at $(date)"

# Backup database
echo "Backing up database {{ db_name }}..."
sudo -u postgres pg_dump {{ db_name }} | gzip > "$BACKUP_DIR/fossology_db_$TIMESTAMP.sql.gz"

{% if backup_repository | default(false) %}
# Backup repository
echo "Backing up repository..."
tar -czf "$BACKUP_DIR/fossology_repo_$TIMESTAMP.tar.gz" -C {{ fossology_repo_dir }} .
{% endif %}

# Clean old backups
echo "Cleaning old backups (older than $RETENTION_DAYS days)..."
find "$BACKUP_DIR" -name "fossology_*.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed at $(date)"
echo "Backup location: $BACKUP_DIR"
ls -lh "$BACKUP_DIR" | tail -5
