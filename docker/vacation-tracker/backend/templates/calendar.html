{% extends "base.html" %}

{% block content %}
  <h1>Team Devops-KT vacation calendar</h1>

  <div class="section-card" style="margin-top: 1rem;">
    <div class="layout-row">
      <section>
        <h2>
          {{ first_day.strftime("%B %Y") }}
        </h2>
        <div class="calendar-nav">
          <a href="{{ url_for('calendar_view', year=prev_year, month=prev_month) }}">
            &laquo; Previous
          </a>
          <a href="{{ url_for('calendar_view', year=next_year, month=next_month) }}">
            Next &raquo;
          </a>
        </div>
        <table class="calendar-grid">
          <thead>
            <tr>
              <th>Mon</th>
              <th>Tue</th>
              <th>Wed</th>
              <th>Thu</th>
              <th>Fri</th>
              <th>Sat</th>
              <th>Sun</th>
            </tr>
          </thead>
          <tbody>
            {% for week in calendar_weeks %}
              <tr>
                {% for day in week %}
                  {% if day %}
                    {% set weekday = day.date.weekday() %}
                    <td class="{% if weekday >= 5 %}weekend{% endif %}">
                      <div class="day-number">{{ day.date.day }}</div>
                      {% if weekday < 5 %}
                        {% for entry in day.vacation_users %}
                          {% set username = entry.username %}
                          {% set comment = entry.comment %}
                          {% set slot = entry.slot %}
                          <div
                            class="vacation-chip{% if comment %} has-comment{% endif %}"
                            style="background: {{ user_colors.get(username, '#e5e7eb') }}; color: #ffffff;"
                            {% if comment %}title="{{ comment }}"{% endif %}
                          >
                            {{ username }}
                            {% if slot == "am" or slot == "pm" %}
                              <span class="slot-badge">{{ slot|upper }}</span>
                            {% endif %}
                            {% if comment %}
                              <span class="comment-indicator" aria-hidden="true">üìù</span>
                            {% endif %}
                          </div>
                        {% endfor %}
                      {% endif %}
                    </td>
                  {% else %}
                    <td></td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </section>

      <section>
        <h2>Book vacation</h2>
        <form method="post">
          {% if is_admin %}
            <div>
              <label for="booking_username">User (leave empty to book for yourself)</label><br>
              <input
                id="booking_username"
                name="booking_username"
                placeholder="{{ g.user }}"
                value="{{ form_booking_username or '' }}"
              >
            </div>
          {% endif %}
          <div>
            <label for="start_date">Start date</label><br>
            <input
              type="date"
              id="start_date"
              name="start_date"
              value="{{ form_start_date or picker_value }}"
              required
            >
          </div>
          <div>
            <label for="end_date">End date</label><br>
            <input
              type="date"
              id="end_date"
              name="end_date"
              value="{{ form_end_date or picker_value }}"
              required
            >
          </div>
          <div>
            <span>Booking type</span><br>
            {% set current_mode = slot_mode or "full" %}
            <label>
              <input
                type="radio"
                name="slot_mode"
                value="full"
                {% if current_mode != "half" %}checked{% endif %}
              >
              Full day
            </label>
            <label style="margin-left: 0.75rem;">
              <input
                type="radio"
                name="slot_mode"
                value="half"
                {% if current_mode == "half" %}checked{% endif %}
              >
              Half day
            </label>
          </div>
          {% set current_half = (slot_half or "") %}
          <div
            id="half-day-options"
            style="margin-left: 1rem; {% if current_mode != 'half' %}display: none;{% endif %}"
          >
            <span>Half-day slot</span><br>
            <label>
              <input
                type="radio"
                name="slot_half"
                value="am"
                {% if current_half == "am" %}checked{% endif %}
              >
              AM
            </label>
            <label style="margin-left: 0.75rem;">
              <input
                type="radio"
                name="slot_half"
                value="pm"
                {% if current_half == "pm" %}checked{% endif %}
              >
              PM
            </label>
          </div>
          <div>
            <label for="comment">Comment (optional)</label><br>
            <textarea id="comment" name="comment" rows="2" style="width: 100%;">{{ form_comment or "" }}</textarea>
          </div>
          <div>
            <button type="submit">Book</button>
          </div>
        </form>
      </section>
    </div>
  </div>

  <div class="section-card" style="margin-top: 1.5rem;">
    <section>
      <h3>Your bookings this month</h3>
      {% if user_bookings %}
        <table class="calendar-grid" style="margin-top: 0.5rem;">
        <thead>
          <tr>
            <th>Start</th>
            <th>End</th>
            <th>Type</th>
            <th>Comment</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for booking in user_bookings %}
            <tr>
              <td>{{ booking.start_date }}</td>
              <td>{{ booking.end_date }}</td>
              <td>
                {% if booking.slot == "am" %}
                  Half day (AM)
                {% elif booking.slot == "pm" %}
                  Half day (PM)
                {% else %}
                  Full day
                {% endif %}
              </td>
              <td>{{ booking.comment or "" }}</td>
              <td style="text-align: center;">
                <a
                  href="{{ url_for('edit_booking', booking_id=booking.id) }}"
                  class="button-secondary"
                >
                  Edit
                </a>
                <form
                  method="post"
                  action="{{ url_for('delete_booking', booking_id=booking.id, year=year, month=month) }}"
                  style="display:inline; margin-left: 0.25rem;"
                >
                  <button type="button" class="button-danger booking-delete-trigger">Remove</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p style="font-size: 0.85rem; color: #6b7280;">No bookings this month yet.</p>
      {% endif %}

      {% if is_admin %}
        <h3 style="margin-top: 1.5rem;">All bookings this month</h3>
      {% if all_bookings %}
        <table class="calendar-grid" style="margin-top: 0.5rem;">
          <thead>
            <tr>
              <th>User</th>
              <th>Start</th>
              <th>End</th>
              <th>Type</th>
              <th>Comment</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for booking in all_bookings %}
              <tr>
                <td>{{ booking.username }}</td>
                <td>{{ booking.start_date }}</td>
                <td>{{ booking.end_date }}</td>
                <td>
                  {% if booking.slot == "am" %}
                    Half day (AM)
                  {% elif booking.slot == "pm" %}
                    Half day (PM)
                  {% else %}
                    Full day
                  {% endif %}
                </td>
                <td>{{ booking.comment or "" }}</td>
                <td style="text-align: center;">
                  <a
                    href="{{ url_for('edit_booking', booking_id=booking.id) }}"
                    class="button-secondary"
                  >
                    Edit
                  </a>
                  <form
                    method="post"
                    action="{{ url_for('delete_booking', booking_id=booking.id, year=year, month=month) }}"
                    style="display:inline; margin-left: 0.25rem;"
                  >
                    <button type="button" class="button-danger booking-delete-trigger">Remove</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="font-size: 0.85rem; color: #6b7280;">No bookings at all this month yet.</p>
      {% endif %}
      {% endif %}
    </section>
  </div>

  <div id="booking-delete-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-dialog">
      <h3>Confirm deletion</h3>
      <p>Are you sure you want to delete this booking?</p>
      <div class="modal-actions">
        <button type="button" class="button-secondary" id="booking-delete-cancel">Cancel</button>
        <button type="button" class="button-danger" id="booking-delete-confirm">Delete</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script>
    (function () {
      const start = document.getElementById("start_date");
      const end = document.getElementById("end_date");
      if (start && end) {
        start.addEventListener("change", function () {
          if (!start.value || !end.value) {
            return;
          }
          if (end.value < start.value) {
            end.value = start.value;
          }
        });
      }

      const modeInputs = document.querySelectorAll('input[name="slot_mode"]');
      const halfOptions = document.getElementById("half-day-options");
      function updateHalfVisibility() {
        if (!halfOptions || !modeInputs.length) return;
        let mode = "full";
        modeInputs.forEach(function (input) {
          if (input.checked) {
            mode = input.value;
          }
        });
        halfOptions.style.display = mode === "half" ? "block" : "none";
      }
      if (modeInputs.length && halfOptions) {
        modeInputs.forEach(function (input) {
          input.addEventListener("change", updateHalfVisibility);
        });
        updateHalfVisibility();
      }

      // Booking delete confirmation modal
      const deleteButtons = document.querySelectorAll(".booking-delete-trigger");
      const modal = document.getElementById("booking-delete-modal");
      const cancelBtn = document.getElementById("booking-delete-cancel");
      const confirmBtn = document.getElementById("booking-delete-confirm");
      let pendingForm = null;

      function showModalForForm(form) {
        pendingForm = form;
        if (modal) {
          modal.style.display = "flex";
        }
      }

      function hideModal() {
        pendingForm = null;
        if (modal) {
          modal.style.display = "none";
        }
      }

      deleteButtons.forEach(function (btn) {
        btn.addEventListener("click", function (e) {
          e.preventDefault();
          const form = btn.closest("form");
          if (form) {
            showModalForForm(form);
          }
        });
      });

      if (cancelBtn) {
        cancelBtn.addEventListener("click", function () {
          hideModal();
        });
      }
      if (confirmBtn) {
        confirmBtn.addEventListener("click", function () {
          if (pendingForm) {
            pendingForm.submit();
          }
          hideModal();
        });
      }
    })();
  </script>
{% endblock %}
